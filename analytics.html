<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èª­æ›¸çµ±è¨ˆ - Novel Viewer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f7fa;
      --card-bg: #fff;
      --text: #333;
      --text-sub: #666;
      --accent: #4a90a4;
      --border: #e0e0e0;
      --success: #27ae60;
    }
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .header {
      background: var(--card-bg);
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .header h1 { font-size: 1.2rem; }
    .header-right { display: flex; gap: 0.5rem; align-items: center; }
    .back-btn, .sync-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      font-size: 0.85rem;
    }
    .sync-btn { background: var(--success); }
    .sync-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .sync-status { font-size: 0.75rem; color: var(--text-sub); }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    .period-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .period-tab {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: var(--card-bg);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    .period-tab.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .card-label {
      font-size: 0.7rem;
      color: var(--text-sub);
      margin-bottom: 0.2rem;
    }
    .card-value {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--accent);
    }
    .card-unit {
      font-size: 0.75rem;
      color: var(--text-sub);
    }
    .chart-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    .chart-title { font-size: 1rem; }
    .chart-container {
      position: relative;
      height: 280px;
    }
    .novel-list {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .novel-list-header {
      padding: 1rem 1.2rem;
      border-bottom: 1px solid var(--border);
      font-weight: bold;
    }
    .novel-item {
      padding: 1rem 1.2rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }
    .novel-item:hover { background: #f8f9fa; }
    .novel-item:last-child { border-bottom: none; }
    .novel-title { font-weight: bold; margin-bottom: 0.3rem; }
    .novel-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.8rem;
      color: var(--text-sub);
      flex-wrap: wrap;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 1rem 1.2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--card-bg);
    }
    .modal-header h2 { font-size: 1.1rem; }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-sub);
    }
    .modal-body { padding: 1rem 1.2rem; }
    .chapter-item {
      padding: 0.8rem;
      border-bottom: 1px solid var(--border);
    }
    .chapter-item:last-child { border-bottom: none; }
    .chapter-name { font-weight: bold; font-size: 0.9rem; }
    .chapter-stats {
      display: flex;
      gap: 0.8rem;
      font-size: 0.75rem;
      color: var(--text-sub);
      margin-top: 0.3rem;
      flex-wrap: wrap;
    }
    .no-data {
      text-align: center;
      padding: 3rem;
      color: var(--text-sub);
    }
    .login-prompt {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .login-prompt p { margin-bottom: 1rem; color: var(--text-sub); }
    .google-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1.2rem;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .google-btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    @media (max-width: 600px) {
      .summary-cards { grid-template-columns: repeat(2, 1fr); }
      .card-value { font-size: 1.1rem; }
      .chart-container { height: 220px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“Š èª­æ›¸çµ±è¨ˆ</h1>
    <div class="header-right">
      <span class="sync-status" id="sync-status"></span>
      <button class="sync-btn" id="sync-btn" style="display:none;">ğŸ”„ åŒæœŸ</button>
      <a href="index.html" class="back-btn">â† æˆ»ã‚‹</a>
    </div>
  </div>

  <div class="container">
    <div id="login-prompt" class="login-prompt" style="display:none;">
      <p>ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«åŒæœŸã§ãã¾ã™</p>
      <button class="google-btn" id="login-btn">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Googleã§ãƒ­ã‚°ã‚¤ãƒ³
      </button>
    </div>

    <div class="period-tabs">
      <button class="period-tab" data-period="today">ä»Šæ—¥</button>
      <button class="period-tab" data-period="week">éå»7æ—¥</button>
      <button class="period-tab active" data-period="month">éå»30æ—¥</button>
      <button class="period-tab" data-period="year">å¹´é–“</button>
      <button class="period-tab" data-period="all">å…¨æœŸé–“</button>
    </div>

    <div class="summary-cards" id="summary-cards"></div>

    <div class="chart-section">
      <div class="chart-header">
        <span class="chart-title">ğŸ“ˆ èª­æ›¸æ™‚é–“</span>
      </div>
      <div class="chart-container">
        <canvas id="timeChart"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-header">
        <span class="chart-title">ğŸ“– èª­æ›¸æ–‡å­—æ•°</span>
      </div>
      <div class="chart-container">
        <canvas id="charsChart"></canvas>
      </div>
    </div>

    <div class="novel-list">
      <div class="novel-list-header">ğŸ“š ä½œå“åˆ¥çµ±è¨ˆ</div>
      <div id="novel-list-body"></div>
    </div>
  </div>

  <div class="modal" id="novel-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">ä½œå“è©³ç´°</h2>
        <button class="close-btn" id="close-modal">Ã—</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/analytics.js"></script>
  <script>
    let currentPeriod = 'month';
    let timeChart = null;
    let charsChart = null;
    let currentUser = null;

    // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatTime(seconds) {
      if (!seconds || seconds < 0) return '0ç§’';
      if (seconds < 60) return `${Math.round(seconds)}ç§’`;
      if (seconds < 3600) return `${Math.round(seconds / 60)}åˆ†`;
      const h = Math.floor(seconds / 3600);
      const m = Math.round((seconds % 3600) / 60);
      return `${h}æ™‚é–“${m}åˆ†`;
    }

    function formatDate(timestamp) {
      const d = new Date(timestamp);
      return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    // æœŸé–“ã«å¿œã˜ãŸæ—¥æ•°ã‚’å–å¾—
    function getPeriodDays(period) {
      switch(period) {
        case 'today': return 1;
        case 'week': return 7;
        case 'month': return 30;
        case 'year': return 365;
        case 'all': return 9999;
        default: return 30;
      }
    }

    // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
    function renderSummary() {
      const days = getPeriodDays(currentPeriod);
      const summary = ReadingStats.getSummaryForPeriod(days);
      const container = document.getElementById('summary-cards');
      
      const cards = [
        { label: 'èª­æ›¸æ™‚é–“', value: formatTime(summary.totalTime), icon: 'â±ï¸' },
        { label: 'èª­æ›¸æ–‡å­—æ•°', value: summary.totalChars.toLocaleString(), unit: 'æ–‡å­—', icon: 'ğŸ“' },
        { label: 'èª­ã‚“ã ä½œå“', value: summary.novelCount, unit: 'ä½œå“', icon: 'ğŸ“š' },
        { label: 'å¹³å‡/æ—¥', value: formatTime(summary.avgTimePerDay), icon: 'ğŸ“…' },
        { label: 'èª­æ›¸é€Ÿåº¦', value: Math.round(summary.avgCharsPerMin || 0), unit: 'æ–‡å­—/åˆ†', icon: 'âš¡' },
        { label: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³', value: summary.totalSessions, unit: 'å›', icon: 'ğŸ”¢' }
      ];

      container.innerHTML = cards.map(c => `
        <div class="card">
          <div class="card-label">${c.icon} ${c.label}</div>
          <div class="card-value">${c.value}</div>
          ${c.unit ? `<div class="card-unit">${c.unit}</div>` : ''}
        </div>
      `).join('');
    }

    // ã‚°ãƒ©ãƒ•æç”»
    function renderCharts() {
      const days = getPeriodDays(currentPeriod);
      const dailyData = ReadingStats.getDailyData(days);
      
      // ãƒ©ãƒ™ãƒ«èª¿æ•´ï¼ˆæœŸé–“ã«å¿œã˜ã¦ï¼‰
      let labels, timeData, charsData;
      
      if (currentPeriod === 'year' || currentPeriod === 'all') {
        // æœˆåˆ¥ã«é›†è¨ˆ
        const monthlyData = {};
        dailyData.forEach(d => {
          const month = d.date.substring(0, 7);
          if (!monthlyData[month]) {
            monthlyData[month] = { totalTime: 0, totalChars: 0 };
          }
          monthlyData[month].totalTime += d.totalTime;
          monthlyData[month].totalChars += d.totalChars;
        });
        labels = Object.keys(monthlyData).map(m => {
          const [y, mon] = m.split('-');
          return `${mon}æœˆ`;
        });
        timeData = Object.values(monthlyData).map(d => Math.round(d.totalTime / 60));
        charsData = Object.values(monthlyData).map(d => d.totalChars);
      } else {
        labels = dailyData.map(d => d.label);
        timeData = dailyData.map(d => Math.round(d.totalTime / 60));
        charsData = dailyData.map(d => d.totalChars);
      }

      // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
      if (timeChart) timeChart.destroy();
      if (charsChart) charsChart.destroy();

      // èª­æ›¸æ™‚é–“ã‚°ãƒ©ãƒ•
      timeChart = new Chart(document.getElementById('timeChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'èª­æ›¸æ™‚é–“ï¼ˆåˆ†ï¼‰',
            data: timeData,
            borderColor: '#4a90a4',
            backgroundColor: 'rgba(74, 144, 164, 0.15)',
            fill: true,
            tension: 0.4,
            pointRadius: days <= 7 ? 5 : 3,
            pointHoverRadius: 7,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.raw}åˆ†`
              }
            }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'åˆ†' } },
            x: { ticks: { maxRotation: 45 } }
          }
        }
      });

      // æ–‡å­—æ•°ã‚°ãƒ©ãƒ•
      charsChart = new Chart(document.getElementById('charsChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'èª­æ›¸æ–‡å­—æ•°',
            data: charsData,
            backgroundColor: 'rgba(74, 144, 164, 0.7)',
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.raw.toLocaleString()}æ–‡å­—`
              }
            }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'æ–‡å­—' } },
            x: { ticks: { maxRotation: 45 } }
          }
        }
      });
    }

    // ä½œå“ãƒªã‚¹ãƒˆè¡¨ç¤º
    function renderNovelList() {
      const novels = ReadingStats.getNovelStats();
      const container = document.getElementById('novel-list-body');

      if (novels.length === 0) {
        container.innerHTML = '<div class="no-data">ã¾ã èª­æ›¸ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      container.innerHTML = novels.map(n => `
        <div class="novel-item" data-id="${n.id}">
          <div class="novel-title">${n.title}</div>
          <div class="novel-meta">
            <span>â±ï¸ ${formatTime(n.totalTime)}</span>
            <span>ğŸ“ ${n.totalChars.toLocaleString()}æ–‡å­—</span>
            <span>ğŸ“– ${Object.keys(n.chapters).length}è©±</span>
          </div>
        </div>
      `).join('');

      container.querySelectorAll('.novel-item').forEach(el => {
        el.addEventListener('click', () => showNovelDetail(el.dataset.id));
      });
    }

    // ä½œå“è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
    function showNovelDetail(novelId) {
      const novels = ReadingStats.getNovelStats();
      const novel = novels.find(n => n.id === novelId);
      if (!novel) return;

      const chapters = ReadingStats.getChapterStats(novelId);
      
      document.getElementById('modal-title').textContent = novel.title;
      
      const body = document.getElementById('modal-body');
      body.innerHTML = `
        <div class="card" style="margin-bottom:1rem;">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;text-align:center;">
            <div>
              <div class="card-label">ç·èª­æ›¸æ™‚é–“</div>
              <div class="card-value" style="font-size:1.1rem;">${formatTime(novel.totalTime)}</div>
            </div>
            <div>
              <div class="card-label">ç·æ–‡å­—æ•°</div>
              <div class="card-value" style="font-size:1.1rem;">${novel.totalChars.toLocaleString()}</div>
            </div>
            <div>
              <div class="card-label">èª­ã‚“ã è©±æ•°</div>
              <div class="card-value" style="font-size:1.1rem;">${chapters.length}</div>
            </div>
          </div>
        </div>
        <h3 style="font-size:0.9rem;margin-bottom:0.5rem;">ğŸ“– ç« åˆ¥çµ±è¨ˆ</h3>
        ${chapters.length === 0 ? '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ãªã—</div>' : 
          chapters.map(c => `
            <div class="chapter-item">
              <div class="chapter-name">ç¬¬${c.chapterIndex + 1}è©±: ${c.title || '(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)'}</div>
              <div class="chapter-stats">
                <span>â±ï¸ ${formatTime(c.totalTime)}</span>
                <span>ğŸ“ ${c.charCount.toLocaleString()}æ–‡å­—</span>
                <span>ğŸ”„ ${c.readCount}å›</span>
                <span>ğŸ“… ${formatDate(c.lastRead)}</span>
              </div>
            </div>
          `).join('')
        }
      `;

      document.getElementById('novel-modal').classList.add('active');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
    document.getElementById('close-modal').addEventListener('click', () => {
      document.getElementById('novel-modal').classList.remove('active');
    });
    document.getElementById('novel-modal').addEventListener('click', (e) => {
      if (e.target.id === 'novel-modal') {
        document.getElementById('novel-modal').classList.remove('active');
      }
    });

    // æœŸé–“ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.period-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentPeriod = tab.dataset.period;
        renderSummary();
        renderCharts();
      });
    });

    // Firebaseèªè¨¼
    firebase.auth().onAuthStateChanged(async (user) => {
      currentUser = user;
      const loginPrompt = document.getElementById('login-prompt');
      const syncBtn = document.getElementById('sync-btn');
      const syncStatus = document.getElementById('sync-status');

      if (user) {
        loginPrompt.style.display = 'none';
        syncBtn.style.display = 'inline-block';
        syncStatus.textContent = `${user.displayName || user.email}`;
        
        // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰çµ±è¨ˆã‚’å–å¾—
        await syncFromCloud();
      } else {
        loginPrompt.style.display = 'block';
        syncBtn.style.display = 'none';
        syncStatus.textContent = '';
      }
      
      renderAll();
    });

    // ãƒ­ã‚°ã‚¤ãƒ³
    document.getElementById('login-btn').addEventListener('click', async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await firebase.auth().signInWithPopup(provider);
      } catch (e) {
        console.error('Login error:', e);
        alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    // åŒæœŸãƒœã‚¿ãƒ³
    document.getElementById('sync-btn').addEventListener('click', async () => {
      const btn = document.getElementById('sync-btn');
      btn.disabled = true;
      btn.textContent = 'åŒæœŸä¸­...';
      
      try {
        await syncToCloud();
        await syncFromCloud();
        renderAll();
        btn.textContent = 'âœ“ å®Œäº†';
        setTimeout(() => { btn.textContent = 'ğŸ”„ åŒæœŸ'; }, 2000);
      } catch (e) {
        console.error('Sync error:', e);
        btn.textContent = 'âŒ å¤±æ•—';
        setTimeout(() => { btn.textContent = 'ğŸ”„ åŒæœŸ'; }, 2000);
      } finally {
        btn.disabled = false;
      }
    });

    // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜
    async function syncToCloud() {
      if (!currentUser) return;
      
      const stats = ReadingStats.getAll();
      const userDoc = firebase.firestore().collection('users').doc(currentUser.uid);
      
      await userDoc.set({
        readingStats: stats,
        statsUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å–å¾—
    async function syncFromCloud() {
      if (!currentUser) return;
      
      try {
        const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          const cloudStats = userDoc.data().readingStats;
          if (cloudStats) {
            ReadingStats.mergeFromCloud(cloudStats);
          }
        }
      } catch (e) {
        console.error('Sync from cloud error:', e);
      }
    }

    function renderAll() {
      renderSummary();
      renderCharts();
      renderNovelList();
    }

    // åˆæœŸåŒ–
    renderAll();
  </script>
</body>
</html>
