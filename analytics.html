<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èª­æ›¸çµ±è¨ˆ - Novel Viewer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f7fa;
      --card-bg: #fff;
      --text: #333;
      --text-sub: #666;
      --accent: #4a90a4;
      --border: #e0e0e0;
    }
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .header {
      background: var(--card-bg);
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 1.2rem; }
    .back-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      font-size: 0.85rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .card-label {
      font-size: 0.75rem;
      color: var(--text-sub);
      margin-bottom: 0.3rem;
    }
    .card-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
    }
    .card-unit {
      font-size: 0.8rem;
      color: var(--text-sub);
    }
    .chart-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .chart-title {
      font-size: 1rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    .chart-container {
      position: relative;
      height: 250px;
    }
    .novel-list {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .novel-list-header {
      padding: 1rem 1.2rem;
      border-bottom: 1px solid var(--border);
      font-weight: bold;
    }
    .novel-item {
      padding: 1rem 1.2rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }
    .novel-item:hover { background: #f8f9fa; }
    .novel-item:last-child { border-bottom: none; }
    .novel-title { font-weight: bold; margin-bottom: 0.3rem; }
    .novel-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.8rem;
      color: var(--text-sub);
    }
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 1rem 1.2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--card-bg);
    }
    .modal-header h2 { font-size: 1.1rem; }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-sub);
    }
    .modal-body { padding: 1rem 1.2rem; }
    .chapter-item {
      padding: 0.8rem;
      border-bottom: 1px solid var(--border);
    }
    .chapter-item:last-child { border-bottom: none; }
    .chapter-name { font-weight: bold; font-size: 0.9rem; }
    .chapter-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
      color: var(--text-sub);
      margin-top: 0.3rem;
    }
    .no-data {
      text-align: center;
      padding: 3rem;
      color: var(--text-sub);
    }
    @media (max-width: 600px) {
      .summary-cards { grid-template-columns: repeat(2, 1fr); }
      .card-value { font-size: 1.2rem; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“Š èª­æ›¸çµ±è¨ˆ</h1>
    <a href="index.html" class="back-btn">â† æˆ»ã‚‹</a>
  </div>

  <div class="container">
    <div class="summary-cards" id="summary-cards"></div>

    <div class="chart-section">
      <div class="chart-title">ğŸ“ˆ æ—¥åˆ¥èª­æ›¸æ™‚é–“ï¼ˆéå»30æ—¥ï¼‰</div>
      <div class="chart-container">
        <canvas id="timeChart"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-title">ğŸ“– æ—¥åˆ¥èª­æ›¸æ–‡å­—æ•°ï¼ˆéå»30æ—¥ï¼‰</div>
      <div class="chart-container">
        <canvas id="charsChart"></canvas>
      </div>
    </div>

    <div class="novel-list">
      <div class="novel-list-header">ğŸ“š ä½œå“åˆ¥çµ±è¨ˆ</div>
      <div id="novel-list-body"></div>
    </div>
  </div>

  <div class="modal" id="novel-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">ä½œå“è©³ç´°</h2>
        <button class="close-btn" id="close-modal">Ã—</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <script src="js/analytics.js"></script>
  <script>
    // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatTime(seconds) {
      if (seconds < 60) return `${Math.round(seconds)}ç§’`;
      if (seconds < 3600) return `${Math.round(seconds / 60)}åˆ†`;
      const h = Math.floor(seconds / 3600);
      const m = Math.round((seconds % 3600) / 60);
      return `${h}æ™‚é–“${m}åˆ†`;
    }

    function formatDate(timestamp) {
      const d = new Date(timestamp);
      return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
    function renderSummary() {
      const summary = ReadingStats.getSummary();
      const container = document.getElementById('summary-cards');
      
      const cards = [
        { label: 'ç·èª­æ›¸æ™‚é–“', value: formatTime(summary.totalTime), icon: 'â±ï¸' },
        { label: 'ç·èª­æ›¸æ–‡å­—æ•°', value: summary.totalChars.toLocaleString(), unit: 'æ–‡å­—', icon: 'ğŸ“' },
        { label: 'èª­ã‚“ã ä½œå“æ•°', value: summary.novelCount, unit: 'ä½œå“', icon: 'ğŸ“š' },
        { label: 'å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³', value: formatTime(summary.avgTimePerSession), icon: 'ğŸ“Š' },
        { label: 'å¹³å‡èª­æ›¸é€Ÿåº¦', value: Math.round(summary.avgCharsPerMin), unit: 'æ–‡å­—/åˆ†', icon: 'âš¡' },
        { label: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°', value: summary.totalSessions, unit: 'å›', icon: 'ğŸ”¢' }
      ];

      container.innerHTML = cards.map(c => `
        <div class="card">
          <div class="card-label">${c.icon} ${c.label}</div>
          <div class="card-value">${c.value}</div>
          ${c.unit ? `<div class="card-unit">${c.unit}</div>` : ''}
        </div>
      `).join('');
    }

    // ã‚°ãƒ©ãƒ•æç”»
    function renderCharts() {
      const dailyData = ReadingStats.getDailyData(30);
      const labels = dailyData.map(d => d.label);

      // èª­æ›¸æ™‚é–“ã‚°ãƒ©ãƒ•
      new Chart(document.getElementById('timeChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'èª­æ›¸æ™‚é–“ï¼ˆåˆ†ï¼‰',
            data: dailyData.map(d => Math.round(d.totalTime / 60)),
            borderColor: '#4a90a4',
            backgroundColor: 'rgba(74, 144, 164, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'åˆ†' } }
          }
        }
      });

      // æ–‡å­—æ•°ã‚°ãƒ©ãƒ•
      new Chart(document.getElementById('charsChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'èª­æ›¸æ–‡å­—æ•°',
            data: dailyData.map(d => d.totalChars),
            backgroundColor: 'rgba(74, 144, 164, 0.7)',
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'æ–‡å­—' } }
          }
        }
      });
    }

    // ä½œå“ãƒªã‚¹ãƒˆè¡¨ç¤º
    function renderNovelList() {
      const novels = ReadingStats.getNovelStats();
      const container = document.getElementById('novel-list-body');

      if (novels.length === 0) {
        container.innerHTML = '<div class="no-data">ã¾ã èª­æ›¸ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      container.innerHTML = novels.map(n => `
        <div class="novel-item" data-id="${n.id}">
          <div class="novel-title">${n.title}</div>
          <div class="novel-meta">
            <span>â±ï¸ ${formatTime(n.totalTime)}</span>
            <span>ğŸ“ ${n.totalChars.toLocaleString()}æ–‡å­—</span>
            <span>ğŸ“– ${Object.keys(n.chapters).length}è©±</span>
          </div>
        </div>
      `).join('');

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      container.querySelectorAll('.novel-item').forEach(el => {
        el.addEventListener('click', () => showNovelDetail(el.dataset.id));
      });
    }

    // ä½œå“è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
    function showNovelDetail(novelId) {
      const novels = ReadingStats.getNovelStats();
      const novel = novels.find(n => n.id === novelId);
      if (!novel) return;

      const chapters = ReadingStats.getChapterStats(novelId);
      
      document.getElementById('modal-title').textContent = novel.title;
      
      const body = document.getElementById('modal-body');
      body.innerHTML = `
        <div class="card" style="margin-bottom:1rem;">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;text-align:center;">
            <div>
              <div class="card-label">ç·èª­æ›¸æ™‚é–“</div>
              <div class="card-value" style="font-size:1.2rem;">${formatTime(novel.totalTime)}</div>
            </div>
            <div>
              <div class="card-label">ç·æ–‡å­—æ•°</div>
              <div class="card-value" style="font-size:1.2rem;">${novel.totalChars.toLocaleString()}</div>
            </div>
            <div>
              <div class="card-label">èª­ã‚“ã è©±æ•°</div>
              <div class="card-value" style="font-size:1.2rem;">${chapters.length}</div>
            </div>
          </div>
        </div>
        <h3 style="font-size:0.9rem;margin-bottom:0.5rem;">ğŸ“– ç« åˆ¥çµ±è¨ˆ</h3>
        ${chapters.length === 0 ? '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ãªã—</div>' : 
          chapters.map(c => `
            <div class="chapter-item">
              <div class="chapter-name">ç¬¬${c.chapterIndex + 1}è©±: ${c.title || '(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)'}</div>
              <div class="chapter-stats">
                <span>â±ï¸ ${formatTime(c.totalTime)}</span>
                <span>ğŸ“ ${c.charCount.toLocaleString()}æ–‡å­—</span>
                <span>ğŸ”„ ${c.readCount}å›</span>
                <span>ğŸ“… ${formatDate(c.lastRead)}</span>
              </div>
            </div>
          `).join('')
        }
      `;

      document.getElementById('novel-modal').classList.add('active');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
    document.getElementById('close-modal').addEventListener('click', () => {
      document.getElementById('novel-modal').classList.remove('active');
    });
    document.getElementById('novel-modal').addEventListener('click', (e) => {
      if (e.target.id === 'novel-modal') {
        document.getElementById('novel-modal').classList.remove('active');
      }
    });

    // åˆæœŸåŒ–
    renderSummary();
    renderCharts();
    renderNovelList();
  </script>
</body>
</html>
